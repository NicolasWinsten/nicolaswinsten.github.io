<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nicolas Winsten</title>
    <meta name="description" content="Nicolas Winsten home page">
		<link rel="stylesheet" href="css/scrollbar.css">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

		<style>
			@keyframes floatright {
				to {left : 100%}
			}

			@keyframes bob {
				from {transform : translateY(-5px)}
				to {transform: translateY(5px)}
			}

			#spaceship-container {
				position: absolute;
				overflow: hidden;
				width: 100%;
				height : 100%;
				left : 0px;
				top : 0px;
			}

			#spaceship {
				position : absolute;
				left : -100%;
				top : 20px;
				animation : floatright 20s linear infinite,
										bob 1s ease-in-out alternate infinite;
			}


		</style>

</head>
<body>
    <div id="app"></div>
		<div id="spaceship-container"><img src="images/spaceship.gif" id="spaceship"></div>
    
    <script src="app.js"></script>

    <script>
			// Elm-UI device class system doesn't seem to work. So I test for mobile this way
			const mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
			app = Elm.Main.init({
					node : document.getElementById("app"),
					flags : {mobile : mobile}
				})

			app.ports.log.subscribe(console.log)

			// use this proxy server to get around CORS
			// const proxy = "https://corsproxy.io/?"
			const proxy = "https://warm-wildwood-58268-a34c03ce30e7.herokuapp.com/"

			// parse the html at the given url into a Document object
			async function retrieveDocument(url) {
				let response = await fetch(url)
				let text = await response.text()
				let parser = new DOMParser()
				return parser.parseFromString(text, "text/html")
			}

			// goodreads does not have an API... so I just do some nasty client-side webscraping.
			// this will most likely break either because goodreads HTML structure changes or the
			// CORS proxy server stops working

			/***
			 * fetch the html for one of my goodreads shelves and scrape out the books.
			 * (only works if the desktop html is retrieved, mobile html doesn't contain the isbns)
			 * 
			 */
			async function retrieveGoodreadsShelf(shelf, numBooks) {
				let goodreadsUrl = `https://www.goodreads.com/review/list/98059963-nicolas?shelf=${shelf}&per_page=${numBooks}`
				let doc = await retrieveDocument(proxy + goodreadsUrl)
				// parse the books from the html table
				let bookTableRows = Array.from(doc.querySelectorAll("tbody#booksBody > tr"))

				let books = bookTableRows.map(entry => ({
					// from each row in the table, retrieve its isbn and rating
					isbn : entry.querySelector("td.field.isbn13 > .value").textContent.trim(),
					// get the rating by counting the number of filled stars in the entry
					rating : Number(entry.querySelectorAll("td.field.rating .staticStar.p10").length),
					// a string indicating the date/month i finished the book
					read_date : entry.querySelector("td.field.date_read > .value").textContent.trim(),
					// author name (last name, first name); sometimes there is an asterisk next to the name so remove it
					author : entry.querySelector("td.field.author > .value").textContent.replace("\*", "").trim(),
					title : entry.querySelector("td.field.title > .value").textContent.trim()
				}))

				return books
			}

			app.ports.fetchGoodReadsShelf.subscribe(({shelf, numBooks}) => {
				console.log("fetching", shelf, "shelf from goodreads")
				retrieveGoodreadsShelf(shelf, numBooks)
					.then(books => app.ports.receiveShelf.send({name : shelf, books : books}))
			})

		</script>
</body>
</html>